<!DOCTYPE html>
<head>
    <meta charset="utf-8">
</head>
<html>
<body>
<svg id="s" width="1920" height="800"></svg>

<script src="build/opentype.js"></script>
<script>

function calcT(v0, v1, v2, v3, t) {
    return Math.pow(1 - t, 3) * v0 +
        3 * Math.pow(1 - t, 2) * t * v1 +
        3 * (1 - t) * Math.pow(t, 2) * v2 +
        Math.pow(t, 3) * v3;
}

function bboxCreate(bbox) {
    return {x1: Number.NaN, y1: Number.NaN, x2: Number.NaN, y2: Number.NaN};
}

function bboxAddPoint(bbox, x, y) {
    if (typeof x === 'number') {
        if (isNaN(bbox.x1) || isNaN(bbox.x2)) {
            bbox.x1 = x;
            bbox.x2 = x;
        }
        if (x < bbox.x1) {
            bbox.x1 = x;
        }
        if (x > bbox.x2) {
            bbox.x2 = x;
        }
    }
    if (typeof y === 'number') {
        if (isNaN(bbox.y1) || isNaN(bbox.y2)) {
            bbox.y1 = y;
            bbox.y2 = y;
        }
        if (y < bbox.y1) {
            bbox.y1 = y;
        }
        if (y > bbox.y2) {
            bbox.y2 = y;
        }
    }
}

function bboxAddX(bbox, x) {
    bboxAddPoint(bbox, x, null);
}

function bboxAddY(bbox, y) {
    bboxAddPoint(bbox, null, y);
}

function bboxAddBezier(bbox, x0, y0, x1, y1, x2, y2, x, y) {
    let p0 = [x0, y0];
    let p1 = [x1, y1];
    let p2 = [x2, y2];
    let p3 = [x, y];

    bboxAddPoint(bbox, x0, y0);
    bboxAddPoint(bbox, x, y);

    for (let i = 0; i <= 1; i++) {
        var b = 6 * p0[i] - 12 * p1[i] + 6 * p2[i];
        var a = -3 * p0[i] + 9 * p1[i] - 9 * p2[i] + 3 * p3[i];
        var c = 3 * p1[i] - 3 * p0[i];

        if (a === 0) {
            if (b === 0) continue;
            var t = -c / b;
            if (0 < t && t < 1) {
                if (i === 0) bboxAddX(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t));
                if (i === 1) bboxAddY(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t));
            }
            continue;
        }

        var b2ac = Math.pow(b, 2) - 4 * c * a;
        if (b2ac < 0) continue;
        var t1 = (-b + Math.sqrt(b2ac)) / (2 * a);
        if (0 < t1 && t1 < 1) {
            if (i === 0) bboxAddX(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t1));
            if (i === 1) bboxAddY(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t1));
        }
        var t2 = (-b - Math.sqrt(b2ac)) / (2 * a);
        if (0 < t2 && t2 < 1) {
            if (i === 0) bboxAddX(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t2));
            if (i === 1) bboxAddY(bbox, calcT(p0[i], p1[i], p2[i], p3[i], t2));
        }
    }
}

function bboxAddQuad(bbox, x0, y0, x1, y1, x, y) {
    let cp1x = x0 + 2 / 3 * (x1 - x0); // CP1 = QP0 + 2/3 *(QP1-QP0)
    var cp1y = y0 + 2 / 3 * (y1 - y0); // CP1 = QP0 + 2/3 *(QP1-QP0)
    var cp2x = cp1x + 1 / 3 * (x - x0); // CP2 = CP1 + 1/3 *(QP2-QP0)
    var cp2y = cp1y + 1 / 3 * (y - y0); // CP2 = CP1 + 1/3 *(QP2-QP0)
    bboxAddBezier(bbox, x0, y0, cp1x, cp1y, cp2x, cp2y, x, y);
}

opentype.Path.prototype.getBoundingBox = function() {
    let bbox = bboxCreate();

    let startX = 0;
    let startY = 0;
    let prevX = 0;
    let prevY = 0;
    for (let i = 0; i < this.commands.length; i++) {
        let cmd = this.commands[i];
        switch(cmd.type) {
            case 'M':
                bboxAddPoint(bbox, cmd.x, cmd.y);
                startX = prevX = cmd.x;
                startY = prevY = cmd.y;
                break;
            case 'L':
                bboxAddPoint(bbox, cmd.x, cmd.y);
                prevX = cmd.x;
                prevY = cmd.y;
                break;
            case 'Q':
                bboxAddQuad(bbox, prevX, prevY, cmd.x1, cmd.y1, cmd.x, cmd.y);
                prevX = cmd.x;
                prevY = cmd.y;
                break;
            case 'C':
                bboxAddBezier(bbox, prevX, prevY, cmd.x1, cmd.y1, cmd.x2, cmd.y2, cmd.x, cmd.y);
                prevX = cmd.x;
                prevY = cmd.y;
                break;
            case 'Z':
                prevX = startX;
                prevY = startY;
                break;
            default:
                throw new Error('Unexpected path commmand ' + cmd.type);
        }
    }
    return bbox;
}

function getBoundingBox(path) {

}

opentype.load('fonts/NotoKufiArabic-Regular.ttf', function(err, font) {
    console.assert(!err, err);
    let path = font.getPath('سنة جديدة سعيدة', 100, 500, 100);
    let svg = document.getElementById('s');
    let el = path.toDOMElement();
    svg.appendChild(el);

    let bbox = path.getBoundingBox();

    let bp = new opentype.Path();
    bp.moveTo(bbox.x1, bbox.y1);
    bp.lineTo(bbox.x2, bbox.y1);
    bp.lineTo(bbox.x2, bbox.y2);
    bp.lineTo(bbox.x1, bbox.y2);
    bp.close();
    let bpEl = bp.toDOMElement();
    bpEl.setAttribute('fill', 'none');
    bpEl.setAttribute('stroke', 'black');
    bpEl.setAttribute('lineWidth', '1');

    svg.appendChild(bpEl);


});
</script>


</body>
</html>
